<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Pessoal</title>
    <link rel="shortcut icon" href="/img/brown-financas.png" type="image/x-icon">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#9a4dff">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .toast {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white min-h-full">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Cabeçalho com Saldos -->
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-center mb-8 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                💰 Controle Financeiro Pessoal
            </h1>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                <div class="bg-gradient-to-r from-green-600 to-green-700 p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm">Saldo Total Geral</p>
                            <p class="text-2xl font-bold" id="saldoTotalGeral">R$ 0,00</p>
                        </div>
                        <div class="text-3xl">💎</div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm">Entradas do Mês</p>
                            <p class="text-2xl font-bold" id="entradasMes">R$ 0,00</p>
                        </div>
                        <div class="text-3xl">📈</div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-red-600 to-red-700 p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-red-100 text-sm">Saídas do Mês</p>
                            <p class="text-2xl font-bold" id="saidasMes">R$ 0,00</p>
                        </div>
                        <div class="text-3xl">📉</div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-purple-600 to-purple-700 p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100 text-sm">Saldo do Mês</p>
                            <p class="text-2xl font-bold" id="saldoMes">R$ 0,00</p>
                        </div>
                        <div class="text-3xl">⚖️</div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-orange-600 to-orange-700 p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-orange-100 text-sm">Transações</p>
                            <p class="text-2xl font-bold" id="quantidadeTransacoes">0</p>
                        </div>
                        <div class="text-3xl">📊</div>
                    </div>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Formulário de Nova Transação -->
            <div class="lg:col-span-1">
                <div class="bg-slate-800/50 backdrop-blur-sm p-6 rounded-xl shadow-xl border border-slate-700">
                    <h2 class="text-2xl font-bold mb-6 flex items-center">
                        <span class="mr-2">➕</span> Nova Transação
                    </h2>
                    
                    <form id="transactionForm" class="space-y-4">
                        <div>
                            <label for="descricao" class="block text-sm font-medium mb-2">Descrição</label>
                            <input type="text" id="descricao" required 
                                   class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label for="valor" class="block text-sm font-medium mb-2">Valor (R$)</label>
                            <input type="number" id="valor" step="0.01" required 
                                   class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label for="categoria" class="block text-sm font-medium mb-2">Categoria</label>
                            <select id="categoria" required 
                                    class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">Selecione uma categoria</option>
                                <option value="Alimentação">🍽️ Alimentação</option>
                                <option value="Transporte">🚗 Transporte</option>
                                <option value="Moradia">🏠 Moradia</option>
                                <option value="Saúde">🏥 Saúde</option>
                                <option value="Educação">📚 Educação</option>
                                <option value="Lazer">🎮 Lazer</option>
                                <option value="Salário">💼 Salário</option>
                                <option value="Freelance">💻 Freelance</option>
                                <option value="Investimento">📈 Investimento</option>
                                <option value="Outros">📦 Outros</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="tipo" class="block text-sm font-medium mb-2">Tipo</label>
                            <select id="tipo" required 
                                    class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">Selecione o tipo</option>
                                <option value="entrada">💰 Entrada</option>
                                <option value="saida">💸 Saída</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="data" class="block text-sm font-medium mb-2">Data</label>
                            <input type="date" id="data" required 
                                   class="w-full p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        
                        <button type="submit" 
                                class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 p-3 rounded-lg font-semibold transition-all duration-200 transform hover:scale-105">
                            ➕ Adicionar Transação
                        </button>
                    </form>
                </div>

                <!-- Controles de Backup -->
                <div class="bg-slate-800/50 backdrop-blur-sm p-6 rounded-xl shadow-xl border border-slate-700 mt-6">
                    <h3 class="text-xl font-bold mb-4">⚙️ Controles</h3>
                    
                    <div class="space-y-3">
                        <button id="backupBtn" 
                                class="w-full bg-blue-600 hover:bg-blue-700 p-3 rounded-lg font-semibold transition-colors">
                            💾 Fazer Backup
                        </button>
                        
                        <div>
                            <input type="file" id="restoreFile" accept=".json" class="hidden">
                            <button id="restoreBtn" 
                                    class="w-full bg-green-600 hover:bg-green-700 p-3 rounded-lg font-semibold transition-colors">
                                📂 Restaurar Backup
                            </button>
                        </div>
                        
                        <button id="clearBtn" 
                                class="w-full bg-red-600 hover:bg-red-700 p-3 rounded-lg font-semibold transition-colors">
                            🗑️ Limpar Tudo
                        </button>
                    </div>
                </div>
            </div>

            <!-- Visão Geral e Gráficos -->
            <div class="lg:col-span-2">
                <!-- Filtros -->
                <div class="bg-slate-800/50 backdrop-blur-sm p-4 rounded-xl shadow-xl border border-slate-700 mb-6">
                    <div class="flex flex-wrap items-center gap-4">
                        <label for="filtroMes" class="font-medium">🔍 Filtrar por:</label>
                        <select id="filtroMes" 
                                class="p-2 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="atual">Mês Atual</option>
                            <option value="anterior">Mês Anterior</option>
                            <option value="todos">Todos os Meses</option>
                        </select>
                    </div>
                </div>



                <!-- Lista de Transações -->
                <div class="bg-slate-800/50 backdrop-blur-sm p-6 rounded-xl shadow-xl border border-slate-700">
                    <h3 class="text-xl font-bold mb-4">📋 Histórico de Transações</h3>
                    <div id="transactionsList" class="space-y-2 max-h-96 overflow-y-auto">
                        <p class="text-slate-400 text-center py-8">Nenhuma transação registrada ainda.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Modal de Confirmação -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-slate-800 p-6 rounded-xl shadow-xl border border-slate-700 max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">⚠️ Confirmação</h3>
            <p id="confirmMessage" class="mb-6 text-slate-300"></p>
            <div class="flex gap-4">
                <button id="confirmYes" class="flex-1 bg-red-600 hover:bg-red-700 p-3 rounded-lg font-semibold transition-colors">
                    Sim, confirmar
                </button>
                <button id="confirmNo" class="flex-1 bg-slate-600 hover:bg-slate-700 p-3 rounded-lg font-semibold transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
class FinanceManager {
    constructor() {
        this.transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        this.saldoTotalGeral = parseFloat(localStorage.getItem('saldoTotalGeral')) || 0;
        this.currentFilter = 'atual';
        
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.setCurrentDate();
        this.updateDisplay();
        this.checkMonthChange();
    }

    setupEventListeners() {
        document.getElementById('transactionForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.addTransaction();
        });

        document.getElementById('filtroMes').addEventListener('change', (e) => {
            this.currentFilter = e.target.value;
            this.updateDisplay();
        });

        document.getElementById('backupBtn').addEventListener('click', () => this.exportBackup && this.exportBackup());
        document.getElementById('restoreBtn').addEventListener('click', () => document.getElementById('restoreFile').click());
        document.getElementById('restoreFile').addEventListener('change', (e) => this.importBackup && this.importBackup(e));
        document.getElementById('clearBtn').addEventListener('click', () => this.confirmClearAll && this.confirmClearAll());

        const confirmYes = document.getElementById('confirmYes');
        const confirmNo = document.getElementById('confirmNo');
        if (confirmYes) confirmYes.addEventListener('click', () => this.clearAll && this.clearAll());
        if (confirmNo) confirmNo.addEventListener('click', () => this.hideConfirmModal && this.hideConfirmModal());
    }

    /* --- Função utilitária que cria Date no fuso LOCAL a partir do input YYYY-MM-DD --- */
    parseDateLocal(dateString) {
        // evita comportamento de interpretação em UTC de new Date('YYYY-MM-DD')
        if (!dateString) return null;
        const [year, month, day] = dateString.split('-').map(Number);
        return new Date(year, month - 1, day);
    }

    /* Formata 'YYYY-MM-DD' para 'DD/MM/YYYY' sem criar objeto Date que cause shift */
    formatDate(dateString) {
        if (!dateString) return '';
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}/${year}`;
    }

    setCurrentDate() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const formattedDate = `${year}-${month}-${day}`;
        const input = document.getElementById('data');
        if (input) {
            input.value = formattedDate;
            input.setAttribute('value', formattedDate);
        }
    }

    checkMonthChange() {
        const lastMonth = localStorage.getItem('lastMonth');
        const currentMonth = new Date().getMonth();
        
        if (lastMonth && parseInt(lastMonth) !== currentMonth) {
            // Novo mês detectado - apenas atualiza referência (sua lógica de zerar mensais deve rodar aqui se desejar)
            localStorage.setItem('lastMonth', currentMonth.toString());
        } else if (!lastMonth) {
            localStorage.setItem('lastMonth', currentMonth.toString());
        }
    }

    addTransaction() {
        const descricao = document.getElementById('descricao').value;
        const valor = parseFloat(document.getElementById('valor').value) || 0;
        const categoria = document.getElementById('categoria').value;
        const tipo = document.getElementById('tipo').value;
        const data = document.getElementById('data').value; // continua sendo 'YYYY-MM-DD'

        const now = new Date();
        const transaction = {
            id: Date.now(),
            descricao,
            valor,
            categoria,
            tipo,
            data, // armazenamos string 'YYYY-MM-DD' — preferível para evitar timezone
            // timestamp local completo (não usado para cálculo de dia/mês)
            timestamp: now.toISOString(),
            horaRegistro: now.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false
            })
        };

        this.transactions.push(transaction);
        
        // Atualizar saldo total geral
        if (tipo === 'entrada') {
            this.saldoTotalGeral += valor;
        } else {
            this.saldoTotalGeral -= valor;
        }

        this.saveData();
        this.updateDisplay();
        this.clearForm();
        this.showToast && this.showToast('Transação adicionada com sucesso!', 'success');
    }

    clearForm() {
        const form = document.getElementById('transactionForm');
        if (form) form.reset();
        this.setCurrentDate();
    }

    getFilteredTransactions() {
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        switch (this.currentFilter) {
            case 'atual':
                return this.transactions.filter(t => {
                    const transactionDate = this.parseDateLocal(t.data);
                    return transactionDate && transactionDate.getMonth() === currentMonth && 
                           transactionDate.getFullYear() === currentYear;
                });
            case 'anterior':
                const previousMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const previousYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                return this.transactions.filter(t => {
                    const transactionDate = this.parseDateLocal(t.data);
                    return transactionDate && transactionDate.getMonth() === previousMonth && 
                           transactionDate.getFullYear() === previousYear;
                });
            case 'todos':
                return this.transactions;
            default:
                return this.transactions;
        }
    }

    getCurrentMonthTransactions() {
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        
        return this.transactions.filter(t => {
            const transactionDate = this.parseDateLocal(t.data);
            return transactionDate && transactionDate.getMonth() === currentMonth && 
                   transactionDate.getFullYear() === currentYear;
        });
    }

    updateDisplay() {
        const filteredTransactions = this.getFilteredTransactions();
        const currentMonthTransactions = this.getCurrentMonthTransactions();

        // Calcular totais do mês atual
        const entradasMes = currentMonthTransactions
            .filter(t => t.tipo === 'entrada')
            .reduce((sum, t) => sum + t.valor, 0);

        const saidasMes = currentMonthTransactions
            .filter(t => t.tipo === 'saida')
            .reduce((sum, t) => sum + t.valor, 0);

        const saldoMes = entradasMes - saidasMes;
        const quantidadeTransacoes = currentMonthTransactions.length;

        // Atualizar elementos do DOM
        const elSaldoTotalGeral = document.getElementById('saldoTotalGeral');
        const elEntradasMes = document.getElementById('entradasMes');
        const elSaidasMes = document.getElementById('saidasMes');
        const elSaldoMes = document.getElementById('saldoMes');
        const elQuantidadeTransacoes = document.getElementById('quantidadeTransacoes');

        if (elSaldoTotalGeral) elSaldoTotalGeral.textContent = this.formatCurrency(this.saldoTotalGeral);
        if (elEntradasMes) elEntradasMes.textContent = this.formatCurrency(entradasMes);
        if (elSaidasMes) elSaidasMes.textContent = this.formatCurrency(saidasMes);
        if (elSaldoMes) {
            elSaldoMes.textContent = this.formatCurrency(saldoMes);
            elSaldoMes.className = saldoMes >= 0 ? 'text-2xl font-bold text-green-300' : 'text-2xl font-bold text-red-300';
        }
        if (elQuantidadeTransacoes) elQuantidadeTransacoes.textContent = quantidadeTransacoes;

        this.updateTransactionsList(filteredTransactions);
    }

    updateTransactionsList(transactions) {
        const container = document.getElementById('transactionsList');
                
        if (!transactions || transactions.length === 0) {
            container.innerHTML = '<p class="text-slate-400 text-center py-8">Nenhuma transação encontrada para o período selecionado.</p>';
            return;
        }

        // Ordena utilizando parseDateLocal para evitar shift de timezone
        const sortedTransactions = transactions.sort((a, b) => {
            const da = this.parseDateLocal(a.data);
            const db = this.parseDateLocal(b.data);
            // se quiser também ordenar por horaRegistro, pode comparar timestamp em seguida
            if (da && db) return db - da;
            if (db) return 1;
            if (da) return -1;
            return 0;
        });
                
        container.innerHTML = sortedTransactions.map(transaction => `
            <div class="bg-slate-700/50 p-4 rounded-lg border border-slate-600 fade-in">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-semibold">${transaction.descricao}</span>
                            <span class="text-xs bg-slate-600 px-2 py-1 rounded">${transaction.categoria}</span>
                        </div>
                        <div class="flex items-center gap-3 text-sm text-slate-400">
                            <span>📅 ${this.formatDate(transaction.data)}</span>
                            ${transaction.horaRegistro ? `<span>🕐 ${transaction.horaRegistro}</span>` : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold ${transaction.tipo === 'entrada' ? 'text-green-400' : 'text-red-400'}">
                            ${transaction.tipo === 'entrada' ? '+' : '-'} ${this.formatCurrency(transaction.valor)}
                        </p>
                        <button onclick="financeManager.removeTransaction(${transaction.id})" 
                                class="text-xs text-red-400 hover:text-red-300 mt-1">
                            🗑️ Remover
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    removeTransaction(id) {
        const transaction = this.transactions.find(t => t.id === id);
        if (transaction) {
            // Reverter do saldo total geral
            if (transaction.tipo === 'entrada') {
                this.saldoTotalGeral -= transaction.valor;
            } else {
                this.saldoTotalGeral += transaction.valor;
            }

            this.transactions = this.transactions.filter(t => t.id !== id);
            this.saveData();
            this.updateDisplay();
            this.showToast && this.showToast('Transação removida com sucesso!', 'success');
        }
    }

    saveData() {
        localStorage.setItem('transactions', JSON.stringify(this.transactions));
        localStorage.setItem('saldoTotalGeral', String(this.saldoTotalGeral));
    }

    // utilitário simples para moeda
    formatCurrency(value) {
        return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    // Placeholder para toasts/modais/backups — deixe suas implementações existentes
    showToast(message, type) {
        // se você já tem implementação, ela permanece; este é fallback mínimo
        const container = document.getElementById('toastContainer');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = 'px-4 py-2 bg-slate-800 text-white rounded';
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
}

// inicializa uma instância global para os botões inline funcionarem
const financeManager = new FinanceManager();
</script>

<script src="app-install.js"></script>

<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9924fa2f10a52800',t:'MTc2MTA5Mzk4Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
