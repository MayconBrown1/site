<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VectorDraw - Editor Vetorial</title>
    <script src="https://unpkg.com/fabric@5.3.0/dist/fabric.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Menu Bar */
        .menu-bar {
            height: 30px;
            background: #0f0f0f;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 13px;
        }

        .menu-item {
            padding: 5px 12px;
            cursor: pointer;
            border-radius: 3px;
            transition: background 0.2s;
        }

        .menu-item:hover {
            background: #333;
        }

        /* Ribbon Toolbar */
        .ribbon-toolbar {
            height: 120px;
            background: linear-gradient(180deg, #2d2d2d 0%, #252525 100%);
            border-bottom: 1px solid #404040;
            display: flex;
            padding: 8px 15px;
            gap: 2px;
        }

        .ribbon-group {
            display: flex;
            flex-direction: column;
            border-right: 1px solid #404040;
            padding: 0 15px;
            min-width: 120px;
        }

        .ribbon-group:last-child {
            border-right: none;
        }

        .ribbon-group-title {
            font-size: 11px;
            color: #999;
            text-align: center;
            margin-top: auto;
            padding-top: 5px;
            border-top: 1px solid #404040;
        }

        .ribbon-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            justify-content: center;
            flex: 1;
            align-items: flex-start;
            padding-top: 5px;
        }

        .ribbon-tool {
            width: 32px;
            height: 32px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 3px;
            color: #e0e0e0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
            position: relative;
        }

        .ribbon-tool:hover {
            background: #404040;
            border-color: #555;
        }

        .ribbon-tool.active {
            background: #0078d4;
            border-color: #106ebe;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .ribbon-tool.large {
            width: 48px;
            height: 48px;
            font-size: 20px;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
        }

        /* Left Toolbar */
        .left-toolbar {
            width: 50px;
            background: #1f1f1f;
            border-right: 1px solid #404040;
            display: flex;
            flex-direction: column;
            padding: 10px 5px;
            gap: 2px;
        }

        .left-tool {
            width: 40px;
            height: 40px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 3px;
            color: #e0e0e0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .left-tool:hover {
            background: #333;
            border-color: #555;
        }

        .left-tool.active {
            background: #0078d4;
            border-color: #106ebe;
        }

        /* Canvas Area */
        .canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .canvas-toolbar {
            height: 40px;
            background: #252525;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 15px;
        }

        .canvas-control {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .canvas-input {
            width: 60px;
            height: 24px;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 3px;
            color: #e0e0e0;
            text-align: center;
            font-size: 11px;
            padding: 0 5px;
        }

        .canvas-input:focus {
            outline: none;
            border-color: #0078d4;
        }

        .canvas-container {
            flex: 1;
            background: #2a2a2a;
            position: relative;
            overflow: hidden;
        }

        .canvas-wrapper {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            border: 1px solid #555;
        }

        /* Right Panel */
        .right-panel {
            width: 280px;
            background: #1f1f1f;
            border-left: 1px solid #404040;
            display: flex;
            flex-direction: column;
        }

        .panel-tabs {
            height: 35px;
            background: #252525;
            border-bottom: 1px solid #404040;
            display: flex;
        }

        .panel-tab {
            flex: 1;
            background: transparent;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .panel-tab:hover {
            color: #e0e0e0;
            background: #2a2a2a;
        }

        .panel-tab.active {
            color: #e0e0e0;
            border-bottom-color: #0078d4;
            background: #1f1f1f;
        }

        .panel-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .property-section {
            margin-bottom: 20px;
        }

        .property-title {
            font-size: 12px;
            font-weight: 600;
            color: #ccc;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .property-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .property-label {
            font-size: 11px;
            color: #999;
            min-width: 40px;
        }

        .color-swatch {
            width: 32px;
            height: 24px;
            border: 1px solid #404040;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .color-picker {
            width: 100%;
            height: 100%;
            border: none;
            cursor: pointer;
            opacity: 0;
            position: absolute;
        }

        .color-display {
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .property-slider {
            flex: 1;
            height: 4px;
            background: #404040;
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .property-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #0078d4;
            border-radius: 50%;
            cursor: pointer;
        }

        .property-input {
            width: 60px;
            height: 24px;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 3px;
            color: #e0e0e0;
            text-align: center;
            font-size: 11px;
            padding: 0 5px;
        }

        .property-input:focus {
            outline: none;
            border-color: #0078d4;
        }

        .action-btn {
            width: 100%;
            height: 28px;
            background: linear-gradient(180deg, #0078d4 0%, #106ebe 100%);
            border: 1px solid #0078d4;
            border-radius: 3px;
            color: white;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 5px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: linear-gradient(180deg, #106ebe 0%, #005a9e 100%);
        }

        .action-btn:active {
            transform: translateY(1px);
        }

        /* Status Bar */
        .status-bar {
            height: 25px;
            background: #0f0f0f;
            border-top: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 11px;
            color: #999;
            gap: 20px;
        }

        .tooltip {
            position: absolute;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s;
            border: 1px solid #404040;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        @media (max-width: 1200px) {
            .ribbon-toolbar {
                height: 80px;
            }
            
            .ribbon-group {
                min-width: 80px;
                padding: 0 8px;
            }
            
            .right-panel {
                width: 240px;
            }
        }

        @media (max-width: 768px) {
            .ribbon-toolbar {
                height: 60px;
                padding: 5px 10px;
            }
            
            .ribbon-tool {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }
            
            .right-panel {
                width: 200px;
            }
            
            .left-toolbar {
                width: 40px;
            }
            
            .left-tool {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Menu Bar -->
        <div class="menu-bar">
            <div class="menu-item">Arquivo</div>
            <div class="menu-item">Editar</div>
            <div class="menu-item">Exibir</div>
            <div class="menu-item">Objeto</div>
            <div class="menu-item">Texto</div>
            <div class="menu-item">Efeitos</div>
            <div class="menu-item">Bitmap</div>
            <div class="menu-item">Janela</div>
            <div class="menu-item">Ajuda</div>
        </div>

        <!-- Ribbon Toolbar -->
        <div class="ribbon-toolbar">
            <div class="ribbon-group">
                <div class="ribbon-tools">
                    <button class="ribbon-tool large" data-tool="select" title="Ferramenta de Seleção (V)">↖</button>
                    <button class="ribbon-tool" onclick="undo()" title="Desfazer (Ctrl+Z)">↶</button>
                    <button class="ribbon-tool" onclick="redo()" title="Refazer (Ctrl+Y)">↷</button>
                </div>
                <div class="ribbon-group-title">SELEÇÃO</div>
            </div>

            <div class="ribbon-group">
                <div class="ribbon-tools">
                    <button class="ribbon-tool" data-tool="rectangle" title="Retângulo (F6)">▭</button>
                    <button class="ribbon-tool" data-tool="ellipse" title="Elipse (F7)">○</button>
                    <button class="ribbon-tool" data-tool="polygon" title="Polígono (Y)">⬟</button>
                    <button class="ribbon-tool" data-tool="text" title="Texto (F8)">T</button>
                </div>
                <div class="ribbon-group-title">OBJETOS</div>
            </div>

            <div class="ribbon-group">
                <div class="ribbon-tools">
                    <button class="ribbon-tool" data-tool="pen" title="Caneta Bézier (B)">✒️</button>
                    <button class="ribbon-tool" data-tool="freehand" title="Mão Livre (F5)">✏️</button>
                    <button class="ribbon-tool" data-tool="shape" title="Forma (F10)">◊</button>
                </div>
                <div class="ribbon-group-title">CURVAS</div>
            </div>

            <div class="ribbon-group">
                <div class="ribbon-tools">
                    <button class="ribbon-tool" data-tool="fill" title="Preenchimento Inteligente">🎨</button>
                    <button class="ribbon-tool" data-tool="eyedropper" title="Conta-gotas">💧</button>
                    <button class="ribbon-tool" data-tool="paintbucket" title="Balde de Tinta">🪣</button>
                </div>
                <div class="ribbon-group-title">PREENCHIMENTO</div>
            </div>

            <div class="ribbon-group">
                <div class="ribbon-tools">
                    <button class="ribbon-tool" data-tool="zoom" title="Zoom (Z)">🔍</button>
                    <button class="ribbon-tool" onclick="fitToPage()" title="Ajustar à Página">⊞</button>
                    <button class="ribbon-tool" onclick="zoomToSelection()" title="Zoom na Seleção">⊡</button>
                </div>
                <div class="ribbon-group-title">VISUALIZAÇÃO</div>
            </div>

            <div class="ribbon-group">
                <div class="ribbon-tools">
                    <button class="ribbon-tool" onclick="exportToPDF()" title="Exportar PDF">📄</button>
                    <button class="ribbon-tool" onclick="exportToSVG()" title="Exportar SVG">🖼️</button>
                </div>
                <div class="ribbon-group-title">EXPORTAR</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Toolbar -->
            <div class="left-toolbar">
                <button class="left-tool active" data-tool="select" title="Seleção (V)">↖</button>
                <button class="left-tool" data-tool="shape" title="Forma (F10)">◊</button>
                <button class="left-tool" data-tool="zoom" title="Zoom (Z)">🔍</button>
                <button class="left-tool" data-tool="freehand" title="Mão Livre (F5)">✏️</button>
                <button class="left-tool" data-tool="pen" title="Caneta (B)">✒️</button>
                <button class="left-tool" data-tool="rectangle" title="Retângulo (R)">▭</button>
                <button class="left-tool" data-tool="ellipse" title="Elipse (E)">○</button>
                <button class="left-tool" data-tool="polygon" title="Polígono (Y)">⬟</button>
                <button class="left-tool" data-tool="text" title="Texto (T)">T</button>
                <button class="left-tool" data-tool="eyedropper" title="Conta-gotas">💧</button>
                <button class="left-tool" data-tool="paintbucket" title="Balde">🪣</button>
                <button class="left-tool" data-tool="eraser" title="Borracha">🧽</button>
            </div>

            <!-- Canvas Area -->
            <div class="canvas-area">
                <div class="canvas-toolbar">
                    <div class="canvas-control">
                        <span>Documento:</span>
                        <input type="number" class="canvas-input" id="width-input" value="210" min="10" max="1000">
                        <span>×</span>
                        <input type="number" class="canvas-input" id="height-input" value="297" min="10" max="1000">
                        <span>mm</span>
                    </div>
                    <div class="canvas-control">
                        <span>Zoom:</span>
                        <span id="zoom-level">100%</span>
                    </div>
                    <div class="canvas-control">
                        <span>Posição:</span>
                        <span id="cursor-pos">0, 0</span>
                    </div>
                </div>

                <div class="canvas-container">
                    <div class="canvas-wrapper">
                        <canvas id="canvas"></canvas>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <div class="panel-tabs">
                    <button class="panel-tab active" data-tab="properties">PROPRIEDADES</button>
                    <button class="panel-tab" data-tab="layers">CAMADAS</button>
                    <button class="panel-tab" data-tab="colors">CORES</button>
                </div>

                <div class="panel-content">
                    <div id="properties-tab" class="tab-content">
                        <div class="property-section">
                            <div class="property-title">Preenchimento</div>
                            <div class="property-row">
                                <span class="property-label">Cor:</span>
                                <div class="color-swatch">
                                    <input type="color" class="color-picker" id="fill-color" value="#ff0000">
                                    <div class="color-display" style="background: #ff0000;"></div>
                                </div>
                                <label style="font-size: 11px;">
                                    <input type="checkbox" id="no-fill"> Sem preenchimento
                                </label>
                            </div>
                        </div>

                        <div class="property-section">
                            <div class="property-title">Contorno</div>
                            <div class="property-row">
                                <span class="property-label">Cor:</span>
                                <div class="color-swatch">
                                    <input type="color" class="color-picker" id="stroke-color" value="#000000">
                                    <div class="color-display" style="background: #000000;"></div>
                                </div>
                            </div>
                            <div class="property-row">
                                <span class="property-label">Espessura:</span>
                                <input type="range" class="property-slider" id="stroke-width" min="0" max="20" value="2">
                                <input type="number" class="property-input" id="stroke-width-input" value="2" min="0" max="20">
                            </div>
                        </div>

                        <div class="property-section">
                            <div class="property-title">Transparência</div>
                            <div class="property-row">
                                <span class="property-label">Opacidade:</span>
                                <input type="range" class="property-slider" id="opacity" min="0" max="100" value="100">
                                <input type="number" class="property-input" id="opacity-input" value="100" min="0" max="100">
                            </div>
                        </div>

                        <div class="property-section">
                            <div class="property-title">Posição & Tamanho</div>
                            <div class="property-row">
                                <span class="property-label">X:</span>
                                <input type="number" id="pos-x" class="property-input">
                                <span class="property-label">Y:</span>
                                <input type="number" id="pos-y" class="property-input">
                            </div>
                            <div class="property-row">
                                <span class="property-label">L:</span>
                                <input type="number" id="obj-width" class="property-input">
                                <span class="property-label">A:</span>
                                <input type="number" id="obj-height" class="property-input">
                            </div>
                        </div>

                        <div class="property-section">
                            <div class="property-title">Edição de Forma</div>
                            <button class="action-btn" onclick="addPointToShape()">+ Adicionar Ponto</button>
                            <button class="action-btn" onclick="removePointFromShape()">- Remover Ponto</button>
                            <button class="action-btn" onclick="finishShapeEdit()">✓ Finalizar Edição</button>
                        </div>
                    </div>

                    <div id="layers-tab" class="tab-content" style="display: none;">
                        <div class="property-section">
                            <div class="property-title">Camadas</div>
                            <div style="background: #252525; padding: 10px; border-radius: 3px; text-align: center; color: #999; font-size: 11px;">
                                Camada 1 (Ativa)
                            </div>
                        </div>
                    </div>

                    <div id="colors-tab" class="tab-content" style="display: none;">
                        <div class="property-section">
                            <div class="property-title">Paleta de Cores</div>
                            <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 3px;">
                                <div style="width: 24px; height: 24px; background: #ff0000; border-radius: 3px; cursor: pointer;" onclick="setFillColor('#ff0000')"></div>
                                <div style="width: 24px; height: 24px; background: #00ff00; border-radius: 3px; cursor: pointer;" onclick="setFillColor('#00ff00')"></div>
                                <div style="width: 24px; height: 24px; background: #0000ff; border-radius: 3px; cursor: pointer;" onclick="setFillColor('#0000ff')"></div>
                                <div style="width: 24px; height: 24px; background: #ffff00; border-radius: 3px; cursor: pointer;" onclick="setFillColor('#ffff00')"></div>
                                <div style="width: 24px; height: 24px; background: #ff00ff; border-radius: 3px; cursor: pointer;" onclick="setFillColor('#ff00ff')"></div>
                                <div style="width: 24px; height: 24px; background: #00ffff; border-radius: 3px; cursor: pointer;" onclick="setFillColor('#00ffff')"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <span>Pronto</span>
            <span>|</span>
            <span id="object-count">0 objetos</span>
            <span>|</span>
            <span>CorelDRAW 2025 - VectorDraw</span>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Inicialização do canvas
        let canvas;
        let currentTool = 'select';
        let isDrawing = false;
        let startX, startY;
        let currentObject = null;
        let undoStack = [];
        let redoStack = [];
        let isShapeEditMode = false;
        let currentPath = null;
        let pathPoints = [];

        // Conversão mm para pixels (aproximadamente 3.78 pixels por mm)
        const mmToPx = 3.78;

        function initCanvas() {
            const canvasElement = document.getElementById('canvas');
            const width = parseInt(document.getElementById('width-input').value) * mmToPx;
            const height = parseInt(document.getElementById('height-input').value) * mmToPx;
            
            canvas = new fabric.Canvas('canvas', {
                width: width,
                height: height,
                backgroundColor: 'white'
            });

            // Configurar eventos do canvas
            canvas.on('mouse:down', onMouseDown);
            canvas.on('mouse:move', onMouseMove);
            canvas.on('mouse:up', onMouseUp);
            canvas.on('selection:created', updateProperties);
            canvas.on('selection:updated', updateProperties);
            canvas.on('selection:cleared', clearProperties);
            canvas.on('object:added', () => {
                saveState();
                updateObjectCount();
            });
            canvas.on('object:removed', () => {
                saveState();
                updateObjectCount();
            });
            canvas.on('object:modified', saveState);
            
            // Track mouse position
            canvas.on('mouse:move', function(e) {
                const pointer = canvas.getPointer(e.e);
                document.getElementById('cursor-pos').textContent = 
                    Math.round(pointer.x) + ', ' + Math.round(pointer.y);
            });
            
            // Salvar estado inicial
            saveState();
            updateObjectCount();
        }

        // Sistema de Undo/Redo
        function saveState() {
            const state = JSON.stringify(canvas.toJSON());
            undoStack.push(state);
            if (undoStack.length > 50) {
                undoStack.shift();
            }
            redoStack = [];
        }

        function undo() {
            if (undoStack.length > 1) {
                redoStack.push(undoStack.pop());
                const previousState = undoStack[undoStack.length - 1];
                canvas.loadFromJSON(previousState, () => {
                    canvas.renderAll();
                });
            }
        }

        function redo() {
            if (redoStack.length > 0) {
                const nextState = redoStack.pop();
                undoStack.push(nextState);
                canvas.loadFromJSON(nextState, () => {
                    canvas.renderAll();
                });
            }
        }

        // Eventos do mouse
        function onMouseDown(e) {
            const pointer = canvas.getPointer(e.e);
            startX = pointer.x;
            startY = pointer.y;

            if (currentTool === 'select') return;
            if (currentTool === 'shape') {
                handleShapeEdit(e);
                return;
            }
            
            isDrawing = true;

            switch (currentTool) {
                case 'rectangle':
                    currentObject = new fabric.Rect({
                        left: startX,
                        top: startY,
                        width: 0,
                        height: 0,
                        fill: document.getElementById('no-fill').checked ? 'transparent' : document.getElementById('fill-color').value,
                        stroke: document.getElementById('stroke-color').value,
                        strokeWidth: parseInt(document.getElementById('stroke-width').value)
                    });
                    canvas.add(currentObject);
                    break;

                case 'ellipse':
                    currentObject = new fabric.Ellipse({
                        left: startX,
                        top: startY,
                        rx: 0,
                        ry: 0,
                        fill: document.getElementById('no-fill').checked ? 'transparent' : document.getElementById('fill-color').value,
                        stroke: document.getElementById('stroke-color').value,
                        strokeWidth: parseInt(document.getElementById('stroke-width').value)
                    });
                    canvas.add(currentObject);
                    break;

                case 'polygon':
                    createPolygon(startX, startY);
                    break;

                case 'text':
                    const text = new fabric.IText('Digite aqui', {
                        left: startX,
                        top: startY,
                        fontFamily: 'Arial',
                        fontSize: 20,
                        fill: document.getElementById('fill-color').value
                    });
                    canvas.add(text);
                    canvas.setActiveObject(text);
                    text.enterEditing();
                    isDrawing = false;
                    break;

                case 'freehand':
                    canvas.isDrawingMode = true;
                    canvas.freeDrawingBrush.width = parseInt(document.getElementById('stroke-width').value);
                    canvas.freeDrawingBrush.color = document.getElementById('stroke-color').value;
                    break;

                case 'bezier':
                case 'pen':
                    handleBezierPen(startX, startY);
                    break;

                case 'zoom':
                    handleZoom(e);
                    break;

                case 'eyedropper':
                    handleEyedropper(e);
                    break;

                case 'paintbucket':
                    handlePaintBucket(e);
                    break;

                case 'eraser':
                    handleEraser(e);
                    break;
            }
        }

        function createPolygon(x, y) {
            const sides = 6; // Hexágono por padrão
            const radius = 50;
            const points = [];
            
            for (let i = 0; i < sides; i++) {
                const angle = (i * 2 * Math.PI) / sides;
                points.push({
                    x: x + radius * Math.cos(angle),
                    y: y + radius * Math.sin(angle)
                });
            }

            currentObject = new fabric.Polygon(points, {
                fill: document.getElementById('no-fill').checked ? 'transparent' : document.getElementById('fill-color').value,
                stroke: document.getElementById('stroke-color').value,
                strokeWidth: parseInt(document.getElementById('stroke-width').value)
            });
            canvas.add(currentObject);
            isDrawing = false;
        }

        function handleBezierPen(x, y) {
            if (!currentPath) {
                pathPoints = [{x: x, y: y}];
                currentPath = new fabric.Path(`M ${x} ${y}`, {
                    fill: '',
                    stroke: document.getElementById('stroke-color').value,
                    strokeWidth: parseInt(document.getElementById('stroke-width').value)
                });
                canvas.add(currentPath);
            } else {
                pathPoints.push({x: x, y: y});
                updatePath();
            }
        }

        function updatePath() {
            if (pathPoints.length < 2) return;
            
            let pathString = `M ${pathPoints[0].x} ${pathPoints[0].y}`;
            for (let i = 1; i < pathPoints.length; i++) {
                pathString += ` L ${pathPoints[i].x} ${pathPoints[i].y}`;
            }
            
            currentPath.path = fabric.util.parsePath(pathString);
            canvas.renderAll();
        }

        function handleZoom(e) {
            const pointer = canvas.getPointer(e.e);
            let zoom = canvas.getZoom();
            zoom = e.e.shiftKey ? zoom * 0.9 : zoom * 1.1;
            if (zoom > 20) zoom = 20;
            if (zoom < 0.01) zoom = 0.01;
            canvas.zoomToPoint(pointer, zoom);
        }

        function handleEyedropper(e) {
            const activeObject = canvas.findTarget(e.e);
            if (activeObject && activeObject.fill) {
                document.getElementById('fill-color').value = activeObject.fill;
            }
            if (activeObject && activeObject.stroke) {
                document.getElementById('stroke-color').value = activeObject.stroke;
            }
        }

        function handlePaintBucket(e) {
            const activeObject = canvas.findTarget(e.e);
            if (activeObject) {
                activeObject.set('fill', document.getElementById('fill-color').value);
                canvas.renderAll();
            }
        }

        function handleEraser(e) {
            const activeObject = canvas.findTarget(e.e);
            if (activeObject) {
                canvas.remove(activeObject);
            }
        }

        function handleShapeEdit(e) {
            const activeObject = canvas.getActiveObject();
            if (!activeObject) return;

            if (activeObject.type === 'polygon' || activeObject.type === 'path') {
                enableShapeEditing(activeObject);
            }
        }

        function enableShapeEditing(obj) {
            isShapeEditMode = true;
            
            // Adicionar pontos de controle para polígonos
            if (obj.type === 'polygon') {
                obj.points.forEach((point, index) => {
                    const controlPoint = new fabric.Circle({
                        left: obj.left + point.x * obj.scaleX,
                        top: obj.top + point.y * obj.scaleY,
                        radius: 5,
                        fill: '#0078d4',
                        stroke: '#fff',
                        strokeWidth: 2,
                        selectable: true,
                        hasControls: false,
                        hasBorders: false,
                        pointIndex: index,
                        parentObject: obj
                    });
                    
                    canvas.add(controlPoint);
                });
            }
        }

        function onMouseMove(e) {
            if (!isDrawing || !currentObject) return;

            const pointer = canvas.getPointer(e.e);
            const width = Math.abs(pointer.x - startX);
            const height = Math.abs(pointer.y - startY);

            switch (currentTool) {
                case 'rectangle':
                    currentObject.set({
                        width: width,
                        height: height,
                        left: Math.min(startX, pointer.x),
                        top: Math.min(startY, pointer.y)
                    });
                    break;

                case 'ellipse':
                    currentObject.set({
                        rx: width / 2,
                        ry: height / 2,
                        left: Math.min(startX, pointer.x),
                        top: Math.min(startY, pointer.y)
                    });
                    break;
            }

            canvas.renderAll();
        }

        function onMouseUp(e) {
            isDrawing = false;
            currentObject = null;
            
            if (currentTool === 'freehand') {
                canvas.isDrawingMode = false;
            }
        }

        // Seleção de ferramentas (ribbon e left toolbar)
        document.querySelectorAll('.ribbon-tool[data-tool], .left-tool[data-tool]').forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active class from all tools
                document.querySelectorAll('.ribbon-tool.active, .left-tool.active').forEach(tool => {
                    tool.classList.remove('active');
                });
                
                // Add active class to clicked tool and corresponding tools
                const toolType = btn.dataset.tool;
                document.querySelectorAll(`[data-tool="${toolType}"]`).forEach(tool => {
                    tool.classList.add('active');
                });
                
                currentTool = toolType;
                
                // Desabilitar modo de desenho livre
                canvas.isDrawingMode = false;
                
                // Configurar cursor baseado na ferramenta
                switch (currentTool) {
                    case 'select':
                        canvas.defaultCursor = 'default';
                        break;
                    case 'zoom':
                        canvas.defaultCursor = 'zoom-in';
                        break;
                    default:
                        canvas.defaultCursor = 'crosshair';
                }
            });
        });

        // Panel tabs functionality
        document.querySelectorAll('.panel-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active from all tabs
                document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
                
                // Activate clicked tab
                tab.classList.add('active');
                const tabName = tab.dataset.tab;
                document.getElementById(tabName + '-tab').style.display = 'block';
            });
        });

        // Atualizar propriedades do objeto selecionado
        function updateProperties() {
            const activeObject = canvas.getActiveObject();
            if (!activeObject) return;

            const fillColor = activeObject.fill || '#ff0000';
            const strokeColor = activeObject.stroke || '#000000';
            const strokeWidth = activeObject.strokeWidth || 2;
            const opacity = (activeObject.opacity || 1) * 100;

            document.getElementById('fill-color').value = fillColor;
            document.getElementById('stroke-color').value = strokeColor;
            document.getElementById('stroke-width').value = strokeWidth;
            document.getElementById('stroke-width-input').value = strokeWidth;
            document.getElementById('opacity').value = opacity;
            document.getElementById('opacity-input').value = opacity;
            document.getElementById('pos-x').value = Math.round(activeObject.left);
            document.getElementById('pos-y').value = Math.round(activeObject.top);
            document.getElementById('obj-width').value = Math.round(activeObject.width * (activeObject.scaleX || 1));
            document.getElementById('obj-height').value = Math.round(activeObject.height * (activeObject.scaleY || 1));

            // Update color displays
            updateColorDisplay('fill-color', fillColor);
            updateColorDisplay('stroke-color', strokeColor);
        }

        function clearProperties() {
            document.getElementById('pos-x').value = '';
            document.getElementById('pos-y').value = '';
            document.getElementById('obj-width').value = '';
            document.getElementById('obj-height').value = '';
        }

        // Eventos dos controles de propriedades
        document.getElementById('fill-color').addEventListener('change', (e) => {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                activeObject.set('fill', e.target.value);
                canvas.renderAll();
                updateColorDisplay('fill-color', e.target.value);
            }
        });

        document.getElementById('stroke-color').addEventListener('change', (e) => {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                activeObject.set('stroke', e.target.value);
                canvas.renderAll();
                updateColorDisplay('stroke-color', e.target.value);
            }
        });

        document.getElementById('stroke-width').addEventListener('input', (e) => {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                activeObject.set('strokeWidth', parseInt(e.target.value));
                canvas.renderAll();
            }
            document.getElementById('stroke-width-input').value = e.target.value;
        });

        document.getElementById('stroke-width-input').addEventListener('input', (e) => {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                activeObject.set('strokeWidth', parseInt(e.target.value));
                canvas.renderAll();
            }
            document.getElementById('stroke-width').value = e.target.value;
        });

        document.getElementById('opacity').addEventListener('input', (e) => {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                activeObject.set('opacity', e.target.value / 100);
                canvas.renderAll();
            }
            document.getElementById('opacity-input').value = e.target.value;
        });

        document.getElementById('opacity-input').addEventListener('input', (e) => {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                activeObject.set('opacity', e.target.value / 100);
                canvas.renderAll();
            }
            document.getElementById('opacity').value = e.target.value;
        });

        function updateColorDisplay(colorId, color) {
            const colorPicker = document.getElementById(colorId);
            const colorDisplay = colorPicker.nextElementSibling;
            if (colorDisplay && colorDisplay.classList.contains('color-display')) {
                colorDisplay.style.background = color;
            }
        }

        // New utility functions
        function fitToPage() {
            canvas.setViewportTransform([1, 0, 0, 1, 0, 0]);
            updateZoomLevel();
        }

        function zoomToSelection() {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                const bound = activeObject.getBoundingRect();
                const zoom = Math.min(
                    canvas.getWidth() / bound.width,
                    canvas.getHeight() / bound.height
                ) * 0.8;
                canvas.zoomToPoint(new fabric.Point(bound.left + bound.width/2, bound.top + bound.height/2), zoom);
                updateZoomLevel();
            }
        }

        function updateZoomLevel() {
            const zoom = Math.round(canvas.getZoom() * 100);
            document.getElementById('zoom-level').textContent = zoom + '%';
        }

        function updateObjectCount() {
            const count = canvas.getObjects().length;
            document.getElementById('object-count').textContent = count + ' objetos';
        }

        function setFillColor(color) {
            document.getElementById('fill-color').value = color;
            updateColorDisplay('fill-color', color);
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                activeObject.set('fill', color);
                canvas.renderAll();
            }
        }



        // Redimensionar canvas
        document.getElementById('width-input').addEventListener('change', updateCanvasSize);
        document.getElementById('height-input').addEventListener('change', updateCanvasSize);

        function updateCanvasSize() {
            const width = parseInt(document.getElementById('width-input').value) * mmToPx;
            const height = parseInt(document.getElementById('height-input').value) * mmToPx;
            canvas.setDimensions({ width: width, height: height });
        }

        // Atalhos de teclado
        document.addEventListener('keydown', (e) => {
            // Verificar se não está editando texto
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undo();
            }
            if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'Z')) {
                e.preventDefault();
                redo();
            }
            if (e.key === 'Delete' || e.key === 'Backspace') {
                const activeObject = canvas.getActiveObject();
                if (activeObject) {
                    canvas.remove(activeObject);
                    e.preventDefault();
                }
            }
            if (e.key === 'Escape') {
                canvas.discardActiveObject();
                canvas.renderAll();
                if (currentPath) {
                    currentPath = null;
                    pathPoints = [];
                }
                isShapeEditMode = false;
            }
            
            // Atalhos de ferramentas
            switch(e.key.toLowerCase()) {
                case 'v': selectTool('select'); break;
                case 'z': selectTool('zoom'); break;
                case 'f': selectTool('freehand'); break;
                case 'b': selectTool('pen'); break;
                case 'r': selectTool('rectangle'); break;
                case 'e': selectTool('ellipse'); break;
                case 't': selectTool('text'); break;
                case 'y': selectTool('polygon'); break;
            }
        });

        function selectTool(toolName) {
            document.querySelector('.tool-btn.active').classList.remove('active');
            document.querySelector(`[data-tool="${toolName}"]`).classList.add('active');
            currentTool = toolName;
            canvas.isDrawingMode = false;
            
            // Configurar cursor
            switch (toolName) {
                case 'select':
                    canvas.defaultCursor = 'default';
                    break;
                case 'zoom':
                    canvas.defaultCursor = 'zoom-in';
                    break;
                default:
                    canvas.defaultCursor = 'crosshair';
            }
        }

        // Funções de edição de forma
        function addPointToShape() {
            const activeObject = canvas.getActiveObject();
            if (!activeObject || activeObject.type !== 'polygon') return;

            // Adicionar um novo ponto no meio da forma
            const points = activeObject.points;
            const newPoint = {
                x: (points[0].x + points[1].x) / 2,
                y: (points[0].y + points[1].y) / 2
            };
            
            points.splice(1, 0, newPoint);
            activeObject.set({ points: points });
            canvas.renderAll();
        }

        function removePointFromShape() {
            const activeObject = canvas.getActiveObject();
            if (!activeObject || activeObject.type !== 'polygon') return;
            
            const points = activeObject.points;
            if (points.length > 3) { // Manter pelo menos 3 pontos
                points.pop();
                activeObject.set({ points: points });
                canvas.renderAll();
            }
        }

        function finishShapeEdit() {
            isShapeEditMode = false;
            // Remover pontos de controle
            const objects = canvas.getObjects();
            objects.forEach(obj => {
                if (obj.pointIndex !== undefined) {
                    canvas.remove(obj);
                }
            });
            canvas.renderAll();
        }

        // Zoom com scroll do mouse
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (canvas) {
                    canvas.on('mouse:wheel', function(opt) {
                        const delta = opt.e.deltaY;
                        let zoom = canvas.getZoom();
                        zoom *= 0.999 ** delta;
                        if (zoom > 20) zoom = 20;
                        if (zoom < 0.01) zoom = 0.01;
                        canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
                        updateZoomLevel();
                        opt.e.preventDefault();
                        opt.e.stopPropagation();
                    });
                }
            }, 100);
        });

        // Exportação
        function exportToPDF() {
            const dataURL = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = 'desenho.png';
            link.href = dataURL;
            link.click();
        }

        function exportToSVG() {
            const svg = canvas.toSVG();
            const blob = new Blob([svg], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = 'desenho.svg';
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Tooltips
        document.querySelectorAll('[title]').forEach(element => {
            element.addEventListener('mouseenter', showTooltip);
            element.addEventListener('mouseleave', hideTooltip);
        });

        function showTooltip(e) {
            const tooltip = document.getElementById('tooltip');
            tooltip.textContent = e.target.title;
            tooltip.style.opacity = '1';
            tooltip.style.left = e.pageX + 10 + 'px';
            tooltip.style.top = e.pageY - 30 + 'px';
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.opacity = '0';
        }

        // Inicializar aplicação
        window.addEventListener('load', () => {
            initCanvas();
            updateZoomLevel();
            updateObjectCount();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97e193ab21730b0d',t:'MTc1NzcwMjg4My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
